# 秘密の匿名掲示板

## 要件定義
  - 認証ができる。
  - 認証した人だけが投稿内容を閲覧できる。
  - 認証した人だけが投稿できる。
  - 自身の投稿内容を削除できる。
  - 管理人機能
      - 管理人の投稿だとわかる。
      - 管理人は全ての投稿を削除できる。
      - 管理人はどのアカウントの投稿かわかる。
  - 匿名であるけれど同じユーザーであることを認識でき、自作自演を防止できる。

## 設計
  - UI(ユーザーインタフェース)設計
  - URI(Uniform Resource Identify)設計
  - モジュール設計

### UI
  - Web ページ1枚で構成することにする。

### URI の構成
  - GET メソッド：/posts  投稿一覧。投稿フォームも設置する。
  - POST メソッド：/posts  投稿とリダイレクト。投稿処理が完了した後、投稿一覧へのリダイレクト処理を行う。
  - POST メソッド：/posts?delete=1  削除。クエリを付けてPOSTを利用する。
  - GET メソッド：/logout  ログアウト。Basic認証の Authorization ヘッダを引き継がない401のステータスコードを返すURLで、このパスにアクセスすると、Basic 認証が解除されログアウトする。
  - GET メソッド：/favicon.ico  ファビコン。アクセスすると、そのサイトのファビコンを確認できる。

### モジュールの構成
  - index.js：HTTP サーバーを起動したり、Basic 認証の設定などを行う。
  - lib/router.js：リクエストを具体的な処理を行うハンドラに振り分ける。
  - lib/posts-handler.js：/posts のリクエストを処理する。
  - lib/handler-utils.js：その他のリクエストを処理する。
  - lib/post.js：投稿の永続的にかかわる具体的な処理である、追加、取得、削除の機能を実現できるようにする。

## 処理の一連の流れ
        アクセス
        ↓
        index.js 
        ↓ 
        router.js を実行
        ↓   URI で処理を分岐
        ↓     → /posts以外 handler-utils.js 
        /posts は posts-handler.js 
        ↓   HTTP メソッドで分岐
        post.js が
          GET なら、取得
          POST で、クエリ無しなら、投稿
          POST で、delete クエリなら、削除

## データベースの構成
  - ID
  - 投稿内容
  - 投稿したユーザー名
  - トラッキングCookieの内容
  - 作成日時
  これらの4つの情報を保存できるように sequelize の実装をする。

## この掲示板で対策する脆弱性
  - XSS 脆弱性
  - パスワード管理の脆弱性
  - セッション固定化攻撃脆弱性
  - CSRF 脆弱性

### トラッキングCookie の要件定義
  トラッキングCookie とは、ユーザーの行動を追跡する為に付与されるCookieのこと。
  - Cookie がついていなければ、追跡するための情報を付与する。
  - Cookie がついていれば、何もしない。
  - 投稿時に Cookie から追跡するための情報を取得してそれを投稿の情報に含める。

  ※　なお、この仕様では、tracking_id が偽装されたときに、サーバーで生成されたことを検証することができない、というセキュリティの問題があるが、ここではそのまま実装することにする。
  
### セッション管理を行う上での重要事項
  1. セッションの識別子を推測されにくいものにする。
  1. セッションの識別子をURLのパラメーターに入れない。
  1. HTTPS通信で利用するCookieには secure 属性を設定する。
  1. ログインが成功したら新しいセッションの識別子を発行する。

### CSRF 脆弱性への対処方法
  1. 一度だけしか利用することができないトークン(ワンタイムトークン)を投稿フォームに埋め込み、そのトークンを消費する形で投稿をさせる。一般的な方法。
  1. 処理を実施する前に ID とパスワードで認証させる。
  1. リクエストのヘッダの Referer というリクエスト元のページを確認してチェックする。

